{"version":3,"file":"bundle.js","sources":["../js/index.js"],"sourcesContent":["const cssFiles = ['ep_full_hyperlinks/static/css/link.css'];\n\n/** **********************************************************************/\n/*                         epLinks Plugin                           */\n/** **********************************************************************/\n\n// Container\nfunction epLinks(context) {\n  this.container = null;\n  this.padOuter = null;\n  this.padInner = null;\n  this.ace = context.ace;\n\n  // Required for instances running on weird ports\n  // This probably needs some work for instances running on root or not on /p/\n  const loc = document.location;\n  const port = loc.port === '' ? (loc.protocol === 'https:' ? 443 : 80) : loc.port;\n  const url = `${loc.protocol}//${loc.hostname}:${port}/link`;\n\n  this.padId = clientVars.padId;\n  this.socket = io.connect(url, {\n    query: `padId=${this.padId}`,\n  });\n\n  this.padId = clientVars.padId;\n  this.links = [];\n  this.mapFakeLinks = [];\n  this.mapOriginalLinksId = [];\n  this.init();\n  this.preLinkMarker = preLinkMark.init(this.ace);\n}\n\n// Init Etherpad plugin link pads\nepLinks.prototype.init = async function () {\n  const self = this;\n\n  // Init prerequisite\n  this.findContainers();\n  this.insertContainers(); // Insert link containers in sidebar\n\n  const links = await this.getLinks();\n  if (!$.isEmptyObject(links)) {\n    this.setLinks(links);\n  }\n\n  this.linkListen();\n\n  // Init add push event\n  this.pushLink('add', (linkId, link) => {\n    this.setLink(linkId, link);\n  });\n\n\n  // On click link icon toolbar\n  $('.addLink').on('click touchstart', (e) => {\n    e.preventDefault(); // stops focus from being lost\n    this.displayNewLinkForm();\n  });\n\n  const submitEditeLink = async function (e) {\n    e.preventDefault();\n    e.stopPropagation();\n    const $linkBox = $(this).closest('.link-container');\n    const $linkForm = $(this).closest('.link-edit-form');\n    const linkId = $linkBox.data('linkid');\n    const linkText = $linkForm.find('#hyperlink-text').val();\n    let hyperlink = $linkForm.find('#hyperlink-url').val();\n    const oldLinkText = $linkForm.find('#hyperlink-text-hidden').val();\n    $linkForm.find('.link-text-text-old').val(linkText);\n    const padOuter = $('iframe[name=\"ace_outer\"]').contents();\n    const padInner = padOuter.find('iframe[name=\"ace_inner\"]');\n    const selector = `.${linkId}`;\n    const ace = self.ace;\n    ace.callWithAce((aceTop) => {\n      const repArr = aceTop.ace_getRepFromSelector(selector, padInner);\n      if (oldLinkText !== linkText) {\n        aceTop.ace_replaceRange(repArr[0][0], repArr[0][1], linkText);\n        if (oldLinkText.length > linkText.length) {\n          repArr[0][1][1] -= oldLinkText.length - linkText.length;\n        } else if (oldLinkText.length < linkText.length) {\n          repArr[0][1][1] += linkText.length - oldLinkText.length;\n        }\n      }\n      ace.callWithAce((ace) => {\n        ace.ace_performSelectionChange(repArr[0][0], repArr[0][1], true);\n        ace.ace_setAttributeOnSelection('link', linkId);\n\n        // Note that this is the correct way of doing it, instead of there being\n        // a linkId we now flag it as \"link-deleted\"\n      });\n    }, 'editLinkedSelection', true);\n\n\n    if (!(/^http:\\/\\//.test(hyperlink)) && !(/^https:\\/\\//.test(hyperlink))) {\n      hyperlink = `http://${hyperlink}`;\n    }\n    const data = {};\n    data.linkId = linkId;\n    data.padId = clientVars.padId;\n    data.linkText = linkText;\n    data.oldLinkText = oldLinkText;\n    data.hyperlink = hyperlink;\n\n    try {\n      await self._send('updateLinkText', data);\n    } catch (err) {\n      if (err.message !== 'unauth') throw err; // Let the uncaught error handler handle it.\n      // $.gritter.add({\n      //   title: 'Error',\n      //   text: 'You cannot edit other users links!',\n      //   class_name: 'error',\n      // });\n      return;\n    }\n\n    $linkBox.removeClass('editing');\n    self.updateLinkBoxText(linkId, linkText, hyperlink);\n    linkBoxes.hideLink(linkId);\n\n    // reverting modal to show because we change it to edit mode\n    self.padOuter.find(`#show-form-${linkId}`).show();\n    self.padOuter.find(`#edit-form-${linkId}`).hide();\n    $linkBox.attr({'data-loaded': false});\n    // although the link was saved on the data base successfully, it needs\n    // to update the link variable with the new text saved\n    self.setLinkNewText(linkId, linkText, hyperlink);\n  };\n\n  // submit the edition on the text and update the link text\n  this.container.parent().on('submit', 'form.link-edit-form', submitEditeLink);\n\n  this.container.on('click', '#link-cancel-btn', function () {\n    const linkId = $(this).closest('.link-container')[0].id;\n    self.padOuter.find(`#show-form-${linkId}`).show();\n    self.padOuter.find(`#edit-form-${linkId}`).hide();\n    linkBoxes.hideLink(linkId);\n  });\n\n  const scrollToFixEditFormInViewport = (linkId) => {\n    const $outerdoc = $('iframe[name=\"ace_outer\"]').contents().find('#outerdocbody');\n    const $outerdocHTML = $outerdoc.parent();\n    const mainHeder = $('#mainHeader').innerHeight();\n    const offsetTop = self.padOuter.find(`#edit-form-${linkId}`).closest('.link-container').offset().top - mainHeder - 25;\n    $outerdocHTML.animate({scrollTop: offsetTop});\n  };\n\n  this.container.parent().on('click', '.ep_hyperlink_docs_bubble_button_edit', function (e) {\n    const linkId = $(this).closest('.link-container')[0].id;\n    self.padOuter.find(`#show-form-${linkId}`).hide();\n    self.padOuter.find(`#edit-form-${linkId}`).show();\n    self.padOuter.find(`#edit-form-${linkId}`)\n        .find('#hyperlink-text')\n        .focus(function () {\n          this.setSelectionRange(this.value.length, this.value.length);\n        }).select();\n\n    if (clientVars.userAgent.isMobile) scrollToFixEditFormInViewport(linkId);\n  });\n\n  this.container.parent().on('click', '.ep_hyperlink_docs_bubble_button_copy', function (e) {\n    const dummy = document.createElement('input');\n    document.body.appendChild(dummy);\n    dummy.value = this.getAttribute('data-hyperlink');\n    dummy.select();\n    document.execCommand('copy');\n    document.body.removeChild(dummy);\n    $.gritter.add({\n      text: 'Link copied to clipboard',\n    });\n    const linkId = $(this).closest('.link-container')[0].id;\n    linkBoxes.hideLink(linkId);\n  });\n\n  this.container.parent().on('click', '.ep_hyperlink_docs_bubble_button_delete', async function () {\n    const linkId = $(this).closest('.link-container')[0].id;\n    self.deleteLink(linkId);\n    const padOuter = $('iframe[name=\"ace_outer\"]').contents();\n    const padInner = padOuter.find('iframe[name=\"ace_inner\"]');\n    const selector = `.${linkId}`;\n    const ace = self.ace;\n    ace.callWithAce((aceTop) => {\n      const repArr = aceTop.ace_getRepFromSelector(selector, padInner);\n      // rep is an array of reps..  I will need to iterate over each to do something meaningful..\n      $.each(repArr, (index, rep) => {\n        // I don't think we need this nested call\n        ace.callWithAce((ace) => {\n          ace.ace_performSelectionChange(rep[0], rep[1], true);\n          ace.ace_setAttributeOnSelection('link', 'link-deleted');\n          // Note that this is the correct way of doing it, instead of there being\n          // a linkId we now flag it as \"link-deleted\"\n        });\n      });\n    }, 'deleteLinkedSelection', true);\n    // dispatch event\n    try {\n      await self._send('deleteLink', {\n        padId: self.padId,\n        linkId,\n        authorId: clientVars.userId,\n      });\n    } catch (err) {\n      if (err.message !== 'unauth') throw err; // Let the uncaught error handler handle it.\n      // $.gritter.add({\n      //   title: 'Error',\n      //   text: 'You cannot delete other users links!',\n      //   class_name: 'error',\n      // });\n      return;\n    }\n  });\n\n  let hideLinkTimer;\n  this.container.on('mouseover', '.sidebar-link', (e) => {\n    // highlight link\n    clearTimeout(hideLinkTimer);\n  }).on('mouseout', '.sidebar-link', (e) => {\n    // do not hide directly the link, because sometime the mouse get out accidently\n    hideLinkTimer = setTimeout(() => {\n      const linkId = e.currentTarget.id;\n      linkBoxes.hideLink(linkId);\n    }, 3000);\n  });\n\n  this.padInner.contents().on('click', '.link', (event) => {\n    event.preventDefault();\n    clearTimeout(hideLinkTimer);\n    const linkId = self.linkIdOf(event);\n    fetch(`/pluginfw/hyperlink/${clientVars.padId}/links/${linkId}`)\n        .then((res) => res.json())\n        .then((res) => {\n          const linkObj = {...res.link, linkId};\n          linkBoxes.showLinkModal(event, linkObj, self.socket);\n        });\n  });\n\n  this.container.parent()\n      .on('click', 'a.ep_hyperlink_title', linkBoxes.internalLinkClick);\n\n\n  this.addListenersToCloseOpenedLink();\n\n  // Enable and handle cookies\n  // if (padcookie.getPref('links') === false) {\n  //   self.padOuter.find('#links').removeClass('active');\n  //   $('#options-links').attr('checked', 'unchecked');\n  //   $('#options-links').attr('checked', false);\n  // } else {\n  //   $('#options-links').attr('checked', 'checked');\n  // }\n\n  // $('#options-links').on('change', () => {\n  //   if ($('#options-links').is(':checked')) {\n  //     enableLinks();\n  //   } else {\n  //     disableLinks();\n  //   }\n  // });\n\n  // function enableLinks() {\n  //   padcookie.setPref('links', true);\n  //   self.padOuter.find('#links').addClass('active');\n  //   $('body').addClass('links-active');\n  //   $('iframe[name=\"ace_outer\"]').contents().find('body').addClass('links-active');\n  // }\n\n  // function disableLinks() {\n  //   padcookie.setPref('links', false);\n  //   self.padOuter.find('#links').removeClass('active');\n  //   $('body').removeClass('links-active');\n  //   $('iframe[name=\"ace_outer\"]').contents().find('body').removeClass('links-active');\n  // }\n\n  // Check to see if we should show already..\n  $('#options-links').trigger('change');\n\n\n  self.padInner.contents().on('copy', (e) => {\n    events.addTextOnClipboard(e, self.padInner, false, self.links);\n  });\n\n  self.padInner.contents().on('cut', (e) => {\n    events.addTextOnClipboard(e, self.padInner, true, self.links);\n  });\n\n  self.padInner.contents().on('paste', (e) => {\n    events.saveLinks(e, self.padInner);\n  });\n};\n\nepLinks.prototype.linkListen = function () {\n  const socket = this.socket;\n  socket.on('pushAddLinkInBulk', async () => {\n    const allLinks = await this.getLinks();\n    if (!$.isEmptyObject(allLinks)) {\n      // we get the Links in this format {c-123:{author:...}, c-124:{author:...}}\n      // but it's expected to be {c-123: {data: {author:...}}, c-124:{data:{author:...}}}\n      // in this.Links\n      const LinksProcessed = {};\n      for (const linkId in allLinks) {\n        if (!Object.hasOwn(allLinks, linkId)) {\n          LinksProcessed[linkId] = {};\n          LinksProcessed[linkId].data = allLinks[linkId];\n        }\n      }\n      this.Links = LinksProcessed;\n    }\n  });\n};\n\n// Insert links container on element use for linenumbers\nepLinks.prototype.findContainers = function () {\n  const padOuter = $('iframe[name=\"ace_outer\"]').contents();\n  this.padOuter = padOuter;\n  this.padInner = padOuter.find('iframe[name=\"ace_inner\"]');\n  this.outerBody = padOuter.find('#outerdocbody');\n};\n\n// set the text of the link\nepLinks.prototype.setLinkNewText = function (linkId, text, hyperlink) {\n  if (this.links[linkId]) {\n    this.links[linkId].data.text = text;\n    this.links[linkId].data.hyperlink = hyperlink;\n  } else if (this.linkReplies[linkId]) {\n    this.linkReplies[linkId].text = text;\n    this.linkReplies[linkId].hyperlink = hyperlink;\n  }\n};\n\nepLinks.prototype.addListenersToCloseOpenedLink = function () {\n  const self = this;\n\n  // we need to add listeners to the different iframes of the page\n  $(document).on('touchstart click', (e) => {\n    self.closeOpenedLinkIfNotOnSelectedElements(e);\n  });\n  this.padOuter.find('html').on('touchstart click', (e) => {\n    self.closeOpenedLinkIfNotOnSelectedElements(e);\n  });\n  this.padInner.contents().find('html').on('touchstart click', (e) => {\n    self.closeOpenedLinkIfNotOnSelectedElements(e);\n  });\n};\n\n// Close link that is opened\nepLinks.prototype.closeOpenedLink = function (e) {\n  // var linkId = this.linkIdOf(e);\n  // linkBoxes.hideLink(linkId);\n  // it was using like above but I decide check hideAllLink\n  linkBoxes.hideAllLinks();\n};\n\n// Close link if event target was outside of link or on a link icon\nepLinks.prototype.closeOpenedLinkIfNotOnSelectedElements = function (e) {\n  // Don't do anything if clicked on the allowed elements:\n  // any of the link icons\n  if (linkBoxes.shouldNotCloseLink(e)) { // a link box or the link modal\n    return;\n  }\n  // All clear, can close the link\n  this.closeOpenedLink(e);\n};\n\nepLinks.prototype.linkIdOf = function (e) {\n  const cls = e.currentTarget.classList;\n  const classLinkId = /(?:^| )(lc-[A-Za-z0-9]*)/.exec(cls);\n\n  return (classLinkId) ? classLinkId[1] : null;\n};\n\n// Insert link container in sidebar\nepLinks.prototype.insertContainers = function () {\n  const linkBoxWrapper = $('iframe[name=\"ace_outer\"]').contents()\n      .find('#outerdocbody')\n      .prepend('<div id=\"linkBoxWrapper\"></div>');\n\n  this.container = linkBoxWrapper;\n};\n\n// Set links content data\nepLinks.prototype.setLinks = function (links) {\n  for (const linkId in links) {\n    this.setLink(linkId, links[linkId]);\n  }\n};\n\n// Set link data\nepLinks.prototype.setLink = function (linkId, link) {\n  const links = this.links;\n  // link.date = timeFormat.prettyDate(link.timestamp);\n  link.formattedDate = new Date(link.timestamp).toISOString();\n\n  if (links[linkId] == null) links[linkId] = {};\n  links[linkId].data = link;\n};\n\n// set the text of the link\nepLinks.prototype.setLinkNewText = function (linkId, text, hyperlink) {\n  if (!this.links[linkId]) return;\n  this.links[linkId].data.text = text;\n  this.links[linkId].data.hyperlink = hyperlink;\n};\n\n// Get all links\nepLinks.prototype.getLinks = async function () {\n  return (await this._send('getLinks', {padId: this.padId})).links;\n};\n\nepLinks.prototype.getLinkData = function () {\n  const data = {};\n\n  // Insert link data\n  data.padId = this.padId;\n  data.link = {};\n  data.link.author = clientVars.userId;\n  data.link.name = pad.myUserInfo.name;\n  data.link.timestamp = new Date().getTime();\n\n  // If client is anonymous\n  if (data.link.name === undefined) {\n    data.link.name = clientVars.userAgent;\n  }\n\n  return data;\n};\n\n// Delete a pad link\nepLinks.prototype.deleteLink = function (linkId) {\n  $('iframe[name=\"ace_outer\"]').contents().find(`#${linkId}`).remove();\n};\n\n// start modal of new link\nepLinks.prototype.displayNewLinkForm = function () {\n  const self = this;\n  const rep = {};\n  const ace = this.ace;\n  ace.callWithAce((ace) => {\n    const saveRep = ace.ace_getRep();\n    rep.lines = saveRep.lines;\n    rep.selStart = saveRep.selStart;\n    rep.selEnd = saveRep.selEnd;\n  }, 'saveLinkedSelection', true);\n\n  const selectedText = self.getSelectedText(rep);\n\n  // we have nothing selected, do nothing\n  const noTextSelected = (selectedText.length === 0);\n  if (noTextSelected) {\n    $.gritter.add({text: 'Please first select the text to link'});\n    return;\n  }\n\n  self.createNewLinkFormIfDontExist(rep);\n\n  // Display form\n  newLink.showNewLinkPopup();\n\n  // Check if the first element selected is visible in the viewport\n  const $firstSelectedElement = self.getFirstElementSelected();\n  const firstSelectedElementInViewport = self.isElementInViewport($firstSelectedElement);\n\n  if (!firstSelectedElementInViewport) {\n    self.scrollViewportIfSelectedTextIsNotVisible($firstSelectedElement);\n  }\n\n  // add selected text to form\n  $('#newLink').find('#hyperlink-text').val(selectedText);\n  $('#newLink').find('#hyperlink-text-hidden').val(selectedText);\n};\n\nepLinks.prototype.scrollViewportIfSelectedTextIsNotVisible = function ($firstSelectedElement) {\n  // Set the top of the form to be the same Y as the target Rep\n  const y = $firstSelectedElement.offsetTop;\n  const padOuter = $('iframe[name=\"ace_outer\"]').contents();\n  padOuter.find('#outerdocbody').scrollTop(y); // Works in Chrome\n  padOuter.find('#outerdocbody').parent().scrollTop(y); // Works in Firefox\n};\n\nepLinks.prototype.isElementInViewport = function (element) {\n  const elementPosition = element.getBoundingClientRect();\n  const scrollTopFirefox = $('iframe[name=\"ace_outer\"]').contents().find('#outerdocbody').parent().scrollTop(); // works only on firefox\n  const scrolltop = $('iframe[name=\"ace_outer\"]').contents().find('#outerdocbody').scrollTop() || scrollTopFirefox;\n  // position relative to the current viewport\n  const elementPositionTopOnViewport = elementPosition.top - scrolltop;\n  const elementPositionBottomOnViewport = elementPosition.bottom - scrolltop;\n\n  const $ace_outer = $('iframe[name=\"ace_outer\"]');\n  const ace_outerHeight = $ace_outer.height();\n  const ace_outerPaddingTop = this.getIntValueOfCSSProperty($ace_outer, 'padding-top');\n\n  const clientHeight = ace_outerHeight - ace_outerPaddingTop;\n\n  const elementAboveViewportTop = elementPositionTopOnViewport < 0;\n  const elementBelowViewportBottom = elementPositionBottomOnViewport > clientHeight;\n\n  return !(elementAboveViewportTop || elementBelowViewportBottom);\n};\n\nepLinks.prototype.getIntValueOfCSSProperty = function ($element, property) {\n  const valueString = $element.css(property);\n  return parseInt(valueString) || 0;\n};\n\nepLinks.prototype.getFirstElementSelected = function () {\n  let element;\n\n  this.ace.callWithAce((ace) => {\n    const rep = ace.ace_getRep();\n    const line = rep.lines.atIndex(rep.selStart[0]);\n    const key = `#${line.key}`;\n    const padOuter = $('iframe[name=\"ace_outer\"]').contents();\n    const padInner = padOuter.find('iframe[name=\"ace_inner\"]').contents();\n    element = padInner.find(key);\n  }, 'getFirstElementSelected', true);\n\n  return element[0];\n};\n\n// Indicates if user selected some text on editor\nepLinks.prototype.checkNoTextSelected = function (rep) {\n  const noTextSelected = ((rep.selStart[0] === rep.selEnd[0]) && (rep.selStart[1] === rep.selEnd[1]));\n\n  return noTextSelected;\n};\n\n// Create form to add link\nepLinks.prototype.createNewLinkFormIfDontExist = function (rep) {\n  const data = this.getLinkData();\n  const self = this;\n\n  // If a new link box doesn't already exist, create one\n  newLink.insertNewLinkPopupIfDontExist(data, (link, index) => {\n    data.link.oldText = link.oldText;\n    data.link.text = link.text;\n    data.link.hyperlink = link.hyperlink;\n    self.saveLink(data, rep);\n  });\n};\n\n// Get a string representation of the text selected on the editor\nepLinks.prototype.getSelectedText = function (rep) {\n  // The selection representation looks like this if it starts with the fifth character in the\n  // second line and ends at (but does not include) the third character in the eighth line:\n  //     rep.selStart = [1, 4]; // 2nd line 5th char\n  //     rep.selEnd = [7, 2]; // 8th line 3rd char\n  const selectedTextLines = [];\n  const lastLine = this.getLastLine(rep.selStart[0], rep);\n  for (let lineNumber = rep.selStart[0]; lineNumber <= lastLine; ++lineNumber) {\n    const line = rep.lines.atIndex(lineNumber);\n    const selStartsAfterLine = rep.selStart[0] > lineNumber ||\n      (rep.selStart[0] === lineNumber && rep.selStart[1] >= line.text.length);\n    if (selStartsAfterLine) continue; // Nothing in this line is selected.\n    const selEndsBeforeLine = rep.selEnd[0] < lineNumber ||\n      (rep.selEnd[0] === lineNumber && rep.selEnd[1] <= 0);\n    if (selEndsBeforeLine) continue; // Nothing in this line is selected.\n    const selStartsBeforeLine = rep.selStart[0] < lineNumber || rep.selStart[1] < 0;\n    const posStart = selStartsBeforeLine ? 0 : rep.selStart[1];\n    const selEndsAfterLine = rep.selEnd[0] > lineNumber || rep.selEnd[1] > line.text.length;\n    const posEnd = selEndsAfterLine ? line.text.length : rep.selEnd[1];\n    // If the selection includes the very beginning of line, and the line has a line marker, it\n    // means the line marker was selected as well. Exclude it from the selected text.\n    selectedTextLines.push(\n        line.text.substring((posStart === 0 && this.lineHasMarker(line)) ? 1 : posStart, posEnd));\n  }\n  return selectedTextLines.join('\\n');\n};\n\nepLinks.prototype.getLastLine = function (firstLine, rep) {\n  let lastLineSelected = rep.selEnd[0];\n\n  if (lastLineSelected > firstLine) {\n    // Ignore last line if the selected text of it it is empty\n    if (this.lastLineSelectedIsEmpty(rep, lastLineSelected)) {\n      lastLineSelected--;\n    }\n  }\n  return lastLineSelected;\n};\n\nepLinks.prototype.lastLineSelectedIsEmpty = function (rep, lastLineSelected) {\n  const line = rep.lines.atIndex(lastLineSelected);\n  // when we've a line with line attribute, the first char line position\n  // in a line is 1 because of the *, otherwise is 0\n  const firstCharLinePosition = this.lineHasMarker(line) ? 1 : 0;\n  const lastColumnSelected = rep.selEnd[1];\n\n  return lastColumnSelected === firstCharLinePosition;\n};\n\nepLinks.prototype.lineHasMarker = function (line) {\n  return line.lineMarker === 1;\n};\n\nepLinks.prototype.cleanLine = function (line, lineText) {\n  const hasALineMarker = this.lineHasMarker(line);\n  if (hasALineMarker) {\n    lineText = lineText.substring(1);\n  }\n  return lineText;\n};\n\n// Save link\nepLinks.prototype.saveLink = async function (data, rep) {\n  const res = await this._send('addLink', data);\n  if (res == null) return;\n  const [linkId, link] = res;\n  link.linkId = linkId;\n\n  this.ace.callWithAce((ace) => {\n    // we should get rep again because the document might have changed..\n    rep = ace.ace_getRep();\n    ace.ace_performSelectionChange(rep.selStart, rep.selEnd, true);\n    ace.ace_setAttributeOnSelection('link', linkId);\n  }, 'insertLink', true);\n\n  this.setLink(linkId, link);\n};\n\n\n// linkData = {c-newlinkId123: data:{author:..., date:..., ...},\n//                c-newlinkId124: data:{...}}\nepLinks.prototype.saveLinkWithoutSelection = async function (padId, linkData) {\n  const data = this.buildLinks(linkData);\n  const links = await this._send('bulkAddLink', padId, data);\n  this.setLinks(links);\n};\n\nepLinks.prototype.buildLinks = function (linksData) {\n  const links = [];\n  for (const linkId in linksData) {\n    if (!Object.hasOwn(linksData, linkId)) {\n      const newLink = this.buildLink(linkId, linksData[linkId].data);\n      links.push(newLink);\n    }\n  }\n  return links;\n};\n\n\n// linkData = {c-newLinkId123: data:{author:..., date:..., ...}, ...\nepLinks.prototype.buildLink = function (linkId, linkData) {\n  const data = {};\n  data.padId = this.padId;\n  data.linkId = linkId;\n  data.text = linkData.text;\n  data.hyperlink = linkData.hyperlink;\n  data.changeTo = linkData.changeTo;\n  data.changeFrom = linkData.changeFrom;\n  data.name = linkData.name;\n  data.timestamp = parseInt(linkData.timestamp);\n\n  return data;\n};\n\n\nepLinks.prototype._send = async function (type, ...args) {\n  return await new Promise((resolve, reject) => {\n    this.socket.emit(type, ...args, (errj, val) => {\n      if (errj != null) return reject(Object.assign(new Error(errj.message), {name: errj.name}));\n      resolve(val);\n    });\n  });\n};\n\nepLinks.prototype.getMapfakeLinks = function () {\n  return this.mapFakeLinks;\n};\n\nepLinks.prototype.findLinkText = function ($linkBox) {\n  return $linkBox.find('.compact-display-content .link-text-text, .full-display-link .link-title-wrapper .link-text-text');\n};\n\nepLinks.prototype.findHyperLinkText = function ($linkBox) {\n  return $linkBox.find('.compact-display-content .link-text-hyperlink, .full-display-link .link-title-wrapper .link-text-hyperlink');\n};\n\nepLinks.prototype.updateLinkBoxText = function (linkId, linkText, hyperlink) {\n  const $link = this.container.parent().find(`[data-linkid='${linkId}']`);\n  $link.attr('data-hyperlink', hyperlink);\n\n  const textBox = this.findLinkText($link);\n  // textBox.text(linkText)\n  textBox.val(linkText);\n\n  const linkBox = this.findHyperLinkText($link);\n  // linkBox.text(hyperlink)\n  linkBox.val(hyperlink);\n};\n\nepLinks.prototype.showChangeAsAccepted = function (linkId) {\n  const self = this;\n\n  // Get the link\n  const link = this.container.parent().find(`[data-linkid='${linkId}']`);\n  // Revert other link that have already been accepted\n  link.closest('.sidebar-link')\n      .find('.link-container.change-accepted').addBack('.change-accepted')\n      .each(function () {\n        $(this).removeClass('change-accepted');\n        const data = {linkId: $(this).attr('data-linkid'), padId: self.padId};\n        self._send('revertChange', data);\n      });\n\n  // this link get accepted\n  link.addClass('change-accepted');\n};\n\n\nepLinks.prototype.showChangeAsReverted = function (linkId) {\n  const self = this;\n  // Get the link\n  const link = self.container.parent().find(`[data-linkid='${linkId}']`);\n  link.removeClass('change-accepted');\n};\n\n// Push link from collaborators\nepLinks.prototype.pushLink = function (eventType, callback) {\n  const socket = this.socket;\n  const self = this;\n\n  socket.on('textLinkUpdated', (linkId, linkText, hyperlink) => {\n    self.updateLinkBoxText(linkId, linkText, hyperlink);\n  });\n\n  socket.on('linkDeleted', (linkId) => {\n    self.deleteLink(linkId);\n  });\n\n  socket.on('changeAccepted', (linkId) => {\n    self.showChangeAsAccepted(linkId);\n  });\n\n  socket.on('changeReverted', (linkId) => {\n    self.showChangeAsReverted(linkId);\n  });\n\n  // On collaborator add a link in the current pad\n  if (eventType === 'add') {\n    socket.on('pushAddLink', (linkId, link) => {\n      callback(linkId, link);\n    });\n  }\n};\n\n/** **********************************************************************/\n/*                           Etherpad Hooks                             */\n/** **********************************************************************/\n\nconst hooks = {\n\n  // Init pad links\n  postAceInit: (hook, context) => {\n    if (!pad.plugins) pad.plugins = {};\n    const Links = new epLinks(context);\n    pad.plugins.ep_full_hyperlinks = Links;\n\n    if (!$('#editorcontainerbox').hasClass('flex-layout')) {\n      $.gritter.add({\n        title: 'Error',\n        text: 'ep_full_hyperlinks: Please upgrade to etherpad 1.8.3 for this plugin to work correctly',\n        sticky: true,\n        class_name: 'error',\n      });\n    }\n    return [];\n  },\n\n  aceEditEvent: (hook, context) => {\n    if (!pad.plugins) pad.plugins = {};\n    // first check if some text is being marked/unmarked to add link to it\n    const eventType = context.callstack.editEvent.eventType;\n\n    if (eventType === 'setup' || eventType === 'setBaseText' || eventType === 'importText') return;\n\n    if (eventType === 'unmarkPreSelectedTextToLink') {\n      pad.plugins.ep_full_hyperlinks.preLinkMarker.handleUnmarkText(context);\n    } else if (eventType === 'markPreSelectedTextToLink') {\n      pad.plugins.ep_full_hyperlinks.preLinkMarker.handleMarkText(context);\n    }\n\n    return [];\n  },\n\n  // Insert links classes\n  aceAttribsToClasses: (hook, context, cb) => {\n    if (context.key === 'link' && context.value !== 'link-deleted') {\n      return ['link', context.value];\n    }\n    // only read marks made by current user\n    if (context.key === preLinkMark.MARK_CLASS && context.value === clientVars.userId) {\n      return [preLinkMark.MARK_CLASS, context.value];\n    }\n    return [];\n  },\n\n  aceEditorCSS: (hookName, context, cb) => cssFiles,\n};\n\n// Given a CSS selector and a target element (in this case pad inner)\n// return the rep as an array of array of tuples IE [[[0,1],[0,2]], [[1,3],[1,5]]]\n// We have to return an array of a array of tuples because there can be multiple reps\n// For a given selector\n// A more sane data structure might be an object such as..\n/*\n0:{\n  xStart: 0,\n  xEnd: 1,\n  yStart: 0,\n  yEnd: 1\n},\n1:...\n*/\n// Alas we follow the Etherpad convention of using tuples here.\nfunction getRepFromSelector(selector, container) {\n  const attributeManager = this.documentAttributeManager;\n\n  const repArr = [];\n\n  // first find the element\n  const elements = container.contents().find(selector);\n  // One might expect this to be a rep for the entire document\n  // However what we actually need to do is find each selection that includes\n  // this link and remove it.  This is because content can be pasted\n  // Mid link which would mean a remove selection could have unexpected consequences\n\n  $.each(elements, (index, span) => {\n    // create a rep array container we can push to..\n    const rep = [[], []];\n\n    // span not be the div so we have to go to parents until we find a div\n    const parentDiv = $(span).closest('div');\n    // line Number is obviously relative to entire document\n    // So find out how many elements before in this parent?\n    const lineNumber = $(parentDiv).prevAll('div').length;\n    // We can set beginning of rep Y (lineNumber)\n    rep[0][0] = lineNumber;\n\n    // We can also update the end rep Y\n    rep[1][0] = lineNumber;\n\n    // Given the link span, how many characters are before it?\n\n    // All we need to know is the number of characters before .foo\n    /*\n\n    <div id=\"boo\">\n      hello\n      <span class='nope'>\n        world\n      </span>\n      are you\n      <span class='foo'>\n        here?\n      </span>\n    </div>\n\n    */\n    // In the example before the correct number would be 21\n    // I guess we could do prevAll each length?\n    // If there are no spans before we get 0, simples!\n    // Note that this only works if spans are being used, which imho\n    // Is the correct container however if block elements are registered\n    // It's plausable that attributes are not maintained :(\n    let leftOffset = 0;\n\n    // If the line has a lineAttribute then leftOffset should be +1\n    // Get each line Attribute on this line..\n    let hasLineAttribute = false;\n    const attrArr = attributeManager.getAttributesOnLine(lineNumber);\n    $.each(attrArr, (attrK, value) => {\n      if (value[0] === 'lmkr') hasLineAttribute = true;\n    });\n    if (hasLineAttribute) leftOffset++;\n\n    $(span).prevAll('span').each(function () {\n      const spanOffset = $(this).text().length;\n      leftOffset += spanOffset;\n    });\n    rep[0][1] = leftOffset;\n\n    // All we need to know is span text length and it's left offset in chars\n    // const spanLength = $(span).text().length;\n\n    rep[1][1] = rep[0][1] + $(span).text().length; // Easy!\n    repArr.push(rep);\n  });\n  return repArr;\n}\n// Once ace is initialized, we set ace_doInsertHeading and bind it to the context\nexport const aceInitialized = (hook, context) => {\n  const editorInfo = context.editorInfo;\n  editorInfo.ace_getRepFromSelector = getRepFromSelector.bind(context);\n};\n\nexport const acePostWriteDomLineHTML = (name, context) => {\n  const hasHyperlink = $(context.node).find('a');\n  if (hasHyperlink.length > 0) {\n    hasHyperlink.each(function () {\n      $(this).on('click', linkBoxes.internalLinkClick);\n    });\n  }\n};\n\nexport const aceEditorCSS = hooks.aceEditorCSS;\nexport const postAceInit = hooks.postAceInit;\nexport const aceAttribsToClasses = hooks.aceAttribsToClasses;\nexport const aceEditEvent = hooks.aceEditEvent;\nexport const collectContentPre = shared.collectContentPre;\n"],"names":["Object","defineProperty","exports","value","cssFiles","epLinks","context","this","container","padOuter","padInner","ace","loc","document","location","port","protocol","url","hostname","padId","clientVars","socket","io","connect","query","links","mapFakeLinks","mapOriginalLinksId","init","preLinkMarker","preLinkMark","prototype","async","self","findContainers","insertContainers","getLinks","$","isEmptyObject","setLinks","linkListen","pushLink","linkId","link","setLink","on","e","preventDefault","displayNewLinkForm","parent","stopPropagation","$linkBox","closest","$linkForm","data","linkText","find","val","hyperlink","oldLinkText","contents","selector","callWithAce","aceTop","repArr","ace_getRepFromSelector","ace_replaceRange","length","ace_performSelectionChange","ace_setAttributeOnSelection","test","_send","err","message","removeClass","updateLinkBoxText","linkBoxes","hideLink","show","hide","attr","setLinkNewText","id","hideLinkTimer","focus","setSelectionRange","select","userAgent","isMobile","$outerdocHTML","mainHeder","innerHeight","offsetTop","offset","top","animate","scrollTop","scrollToFixEditFormInViewport","dummy","createElement","body","appendChild","getAttribute","execCommand","removeChild","gritter","add","text","deleteLink","each","index","rep","authorId","userId","clearTimeout","setTimeout","currentTarget","event","linkIdOf","fetch","then","res","json","linkObj","showLinkModal","internalLinkClick","addListenersToCloseOpenedLink","trigger","events","addTextOnClipboard","saveLinks","allLinks","LinksProcessed","hasOwn","Links","outerBody","linkReplies","closeOpenedLinkIfNotOnSelectedElements","closeOpenedLink","hideAllLinks","shouldNotCloseLink","cls","classList","classLinkId","exec","linkBoxWrapper","prepend","formattedDate","Date","timestamp","toISOString","getLinkData","author","name","pad","myUserInfo","getTime","undefined","remove","saveRep","ace_getRep","lines","selStart","selEnd","selectedText","getSelectedText","createNewLinkFormIfDontExist","newLink","showNewLinkPopup","$firstSelectedElement","getFirstElementSelected","isElementInViewport","scrollViewportIfSelectedTextIsNotVisible","y","element","elementPosition","getBoundingClientRect","scrollTopFirefox","scrolltop","elementPositionTopOnViewport","elementPositionBottomOnViewport","bottom","$ace_outer","ace_outerHeight","height","ace_outerPaddingTop","getIntValueOfCSSProperty","$element","property","valueString","css","parseInt","key","atIndex","checkNoTextSelected","insertNewLinkPopupIfDontExist","oldText","saveLink","selectedTextLines","lastLine","getLastLine","lineNumber","line","posStart","posEnd","push","substring","lineHasMarker","join","firstLine","lastLineSelected","lastLineSelectedIsEmpty","firstCharLinePosition","lineMarker","cleanLine","lineText","saveLinkWithoutSelection","linkData","buildLinks","linksData","buildLink","changeTo","changeFrom","type","args","Promise","resolve","reject","emit","errj","assign","Error","getMapfakeLinks","findLinkText","findHyperLinkText","$link","showChangeAsAccepted","addBack","addClass","showChangeAsReverted","eventType","callback","getRepFromSelector","attributeManager","documentAttributeManager","elements","span","parentDiv","prevAll","leftOffset","hasLineAttribute","attrArr","getAttributesOnLine","attrK","spanOffset","aceEditorCSS","hookName","cb","postAceInit","hook","plugins","ep_full_hyperlinks","hasClass","title","sticky","class_name","aceAttribsToClasses","MARK_CLASS","aceEditEvent","callstack","editEvent","handleUnmarkText","handleMarkText","collectContentPre","shared","aceInitialized","editorInfo","bind","acePostWriteDomLineHTML","hasHyperlink","node"],"mappings":"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"}