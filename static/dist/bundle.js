"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e=["ep_full_hyperlinks/static/css/link.css"];function t(e){this.container=null,this.padOuter=null,this.padInner=null,this.ace=e.ace;const t=document.location,n=""===t.port?"https:"===t.protocol?443:80:t.port,i=`${t.protocol}//${t.hostname}:${n}/link`;this.padId=clientVars.padId,this.socket=io.connect(i,{query:`padId=${this.padId}`}),this.padId=clientVars.padId,this.links=[],this.mapFakeLinks=[],this.mapOriginalLinksId=[],this.init(),this.preLinkMarker=preLinkMark.init(this.ace)}t.prototype.init=async function(){const e=this;this.findContainers(),this.insertContainers();const t=await this.getLinks();$.isEmptyObject(t)||this.setLinks(t),this.linkListen(),this.pushLink("add",((e,t)=>{this.setLink(e,t)})),$(".addLink").on("click touchstart",(e=>{e.preventDefault(),this.displayNewLinkForm()}));this.container.parent().on("submit","form.link-edit-form",(async function(t){t.preventDefault(),t.stopPropagation();const n=$(this).closest(".link-container"),i=$(this).closest(".link-edit-form"),o=n.data("linkid"),s=i.find("#hyperlink-text").val();let a=i.find("#hyperlink-url").val();const r=i.find("#hyperlink-text-hidden").val();i.find(".link-text-text-old").val(s);const l=$('iframe[name="ace_outer"]').contents().find('iframe[name="ace_inner"]'),c=`.${o}`,d=e.ace;d.callWithAce((e=>{const t=e.ace_getRepFromSelector(c,l);r!==s&&(e.ace_replaceRange(t[0][0],t[0][1],s),r.length>s.length?t[0][1][1]-=r.length-s.length:r.length<s.length&&(t[0][1][1]+=s.length-r.length)),d.callWithAce((e=>{e.ace_performSelectionChange(t[0][0],t[0][1],!0),e.ace_setAttributeOnSelection("link",o)}))}),"editLinkedSelection",!0),/^http:\/\//.test(a)||/^https:\/\//.test(a)||(a=`http://${a}`);const p={};p.linkId=o,p.padId=clientVars.padId,p.linkText=s,p.oldLinkText=r,p.hyperlink=a;try{await e._send("updateLinkText",p)}catch(e){if("unauth"!==e.message)throw e;return}n.removeClass("editing"),e.updateLinkBoxText(o,s,a),linkBoxes.hideLink(o),e.padOuter.find(`#show-form-${o}`).show(),e.padOuter.find(`#edit-form-${o}`).hide(),n.attr({"data-loaded":!1}),e.setLinkNewText(o,s,a)})),this.container.on("click","#link-cancel-btn",(function(){const t=$(this).closest(".link-container")[0].id;e.padOuter.find(`#show-form-${t}`).show(),e.padOuter.find(`#edit-form-${t}`).hide(),linkBoxes.hideLink(t)}));let n;this.container.parent().on("click",".ep_hyperlink_docs_bubble_button_edit",(function(t){const n=$(this).closest(".link-container")[0].id;e.padOuter.find(`#show-form-${n}`).hide(),e.padOuter.find(`#edit-form-${n}`).show(),e.padOuter.find(`#edit-form-${n}`).find("#hyperlink-text").focus((function(){this.setSelectionRange(this.value.length,this.value.length)})).select(),clientVars.userAgent.isMobile&&(t=>{const n=$('iframe[name="ace_outer"]').contents().find("#outerdocbody").parent(),i=$("#mainHeader").innerHeight(),o=e.padOuter.find(`#edit-form-${t}`).closest(".link-container").offset().top-i-25;n.animate({scrollTop:o})})(n)})),this.container.parent().on("click",".ep_hyperlink_docs_bubble_button_copy",(function(e){const t=document.createElement("input");document.body.appendChild(t),t.value=this.getAttribute("data-hyperlink"),t.select(),document.execCommand("copy"),document.body.removeChild(t),$.gritter.add({text:"Link copied to clipboard"});const n=$(this).closest(".link-container")[0].id;linkBoxes.hideLink(n)})),this.container.parent().on("click",".ep_hyperlink_docs_bubble_button_delete",(async function(){const t=$(this).closest(".link-container")[0].id;e.deleteLink(t);const n=$('iframe[name="ace_outer"]').contents().find('iframe[name="ace_inner"]'),i=`.${t}`,o=e.ace;o.callWithAce((e=>{const t=e.ace_getRepFromSelector(i,n);$.each(t,((e,t)=>{o.callWithAce((e=>{e.ace_performSelectionChange(t[0],t[1],!0),e.ace_setAttributeOnSelection("link","link-deleted")}))}))}),"deleteLinkedSelection",!0);try{await e._send("deleteLink",{padId:e.padId,linkId:t,authorId:clientVars.userId})}catch(e){if("unauth"!==e.message)throw e;return}})),this.container.on("mouseover",".sidebar-link",(e=>{clearTimeout(n)})).on("mouseout",".sidebar-link",(e=>{n=setTimeout((()=>{const t=e.currentTarget.id;linkBoxes.hideLink(t)}),3e3)})),this.padInner.contents().on("click",".link",(t=>{t.preventDefault(),clearTimeout(n);const i=e.linkIdOf(t);fetch(`/pluginfw/hyperlink/${clientVars.padId}/links/${i}`).then((e=>e.json())).then((n=>{const o={...n.link,linkId:i};linkBoxes.showLinkModal(t,o,e.socket)}))})),this.container.parent().on("click","a.ep_hyperlink_title",linkBoxes.internalLinkClick),this.addListenersToCloseOpenedLink(),$("#options-links").trigger("change"),e.padInner.contents().on("copy",(t=>{events.addTextOnClipboard(t,e.padInner,!1,e.links)})),e.padInner.contents().on("cut",(t=>{events.addTextOnClipboard(t,e.padInner,!0,e.links)})),e.padInner.contents().on("paste",(t=>{events.saveLinks(t,e.padInner)}))},t.prototype.linkListen=function(){this.socket.on("pushAddLinkInBulk",(async()=>{const e=await this.getLinks();if(!$.isEmptyObject(e)){const t={};for(const n in e)Object.hasOwn(e,n)||(t[n]={},t[n].data=e[n]);this.Links=t}}))},t.prototype.findContainers=function(){const e=$('iframe[name="ace_outer"]').contents();this.padOuter=e,this.padInner=e.find('iframe[name="ace_inner"]'),this.outerBody=e.find("#outerdocbody")},t.prototype.setLinkNewText=function(e,t,n){this.links[e]?(this.links[e].data.text=t,this.links[e].data.hyperlink=n):this.linkReplies[e]&&(this.linkReplies[e].text=t,this.linkReplies[e].hyperlink=n)},t.prototype.addListenersToCloseOpenedLink=function(){const e=this;$(document).on("touchstart click",(t=>{e.closeOpenedLinkIfNotOnSelectedElements(t)})),this.padOuter.find("html").on("touchstart click",(t=>{e.closeOpenedLinkIfNotOnSelectedElements(t)})),this.padInner.contents().find("html").on("touchstart click",(t=>{e.closeOpenedLinkIfNotOnSelectedElements(t)}))},t.prototype.closeOpenedLink=function(e){linkBoxes.hideAllLinks()},t.prototype.closeOpenedLinkIfNotOnSelectedElements=function(e){linkBoxes.shouldNotCloseLink(e)||this.closeOpenedLink(e)},t.prototype.linkIdOf=function(e){const t=e.currentTarget.classList,n=/(?:^| )(lc-[A-Za-z0-9]*)/.exec(t);return n?n[1]:null},t.prototype.insertContainers=function(){const e=$('iframe[name="ace_outer"]').contents().find("#outerdocbody").prepend('<div id="linkBoxWrapper"></div>');this.container=e},t.prototype.setLinks=function(e){for(const t in e)this.setLink(t,e[t])},t.prototype.setLink=function(e,t){const n=this.links;t.formattedDate=new Date(t.timestamp).toISOString(),null==n[e]&&(n[e]={}),n[e].data=t},t.prototype.setLinkNewText=function(e,t,n){this.links[e]&&(this.links[e].data.text=t,this.links[e].data.hyperlink=n)},t.prototype.getLinks=async function(){return(await this._send("getLinks",{padId:this.padId})).links},t.prototype.getLinkData=function(){const e={};return e.padId=this.padId,e.link={},e.link.author=clientVars.userId,e.link.name=pad.myUserInfo.name,e.link.timestamp=(new Date).getTime(),void 0===e.link.name&&(e.link.name=clientVars.userAgent),e},t.prototype.deleteLink=function(e){$('iframe[name="ace_outer"]').contents().find(`#${e}`).remove()},t.prototype.displayNewLinkForm=function(){const e=this,t={};this.ace.callWithAce((e=>{const n=e.ace_getRep();t.lines=n.lines,t.selStart=n.selStart,t.selEnd=n.selEnd}),"saveLinkedSelection",!0);const n=e.getSelectedText(t);if(0===n.length)return void $.gritter.add({text:"Please first select the text to link"});e.createNewLinkFormIfDontExist(t),newLink.showNewLinkPopup();const i=e.getFirstElementSelected();e.isElementInViewport(i)||e.scrollViewportIfSelectedTextIsNotVisible(i),$("#newLink").find("#hyperlink-text").val(n),$("#newLink").find("#hyperlink-text-hidden").val(n)},t.prototype.scrollViewportIfSelectedTextIsNotVisible=function(e){const t=e.offsetTop,n=$('iframe[name="ace_outer"]').contents();n.find("#outerdocbody").scrollTop(t),n.find("#outerdocbody").parent().scrollTop(t)},t.prototype.isElementInViewport=function(e){const t=e.getBoundingClientRect(),n=$('iframe[name="ace_outer"]').contents().find("#outerdocbody").parent().scrollTop(),i=$('iframe[name="ace_outer"]').contents().find("#outerdocbody").scrollTop()||n,o=t.top-i,s=t.bottom-i,a=$('iframe[name="ace_outer"]'),r=a.height(),l=this.getIntValueOfCSSProperty(a,"padding-top");return!(o<0||s>r-l)},t.prototype.getIntValueOfCSSProperty=function(e,t){const n=e.css(t);return parseInt(n)||0},t.prototype.getFirstElementSelected=function(){let e;return this.ace.callWithAce((t=>{const n=t.ace_getRep(),i=`#${n.lines.atIndex(n.selStart[0]).key}`,o=$('iframe[name="ace_outer"]').contents().find('iframe[name="ace_inner"]').contents();e=o.find(i)}),"getFirstElementSelected",!0),e[0]},t.prototype.checkNoTextSelected=function(e){return e.selStart[0]===e.selEnd[0]&&e.selStart[1]===e.selEnd[1]},t.prototype.createNewLinkFormIfDontExist=function(e){const t=this.getLinkData(),n=this;newLink.insertNewLinkPopupIfDontExist(t,((i,o)=>{t.link.oldText=i.oldText,t.link.text=i.text,t.link.hyperlink=i.hyperlink,n.saveLink(t,e)}))},t.prototype.getSelectedText=function(e){const t=[],n=this.getLastLine(e.selStart[0],e);for(let i=e.selStart[0];i<=n;++i){const n=e.lines.atIndex(i);if(e.selStart[0]>i||e.selStart[0]===i&&e.selStart[1]>=n.text.length)continue;if(e.selEnd[0]<i||e.selEnd[0]===i&&e.selEnd[1]<=0)continue;const o=e.selStart[0]<i||e.selStart[1]<0?0:e.selStart[1],s=e.selEnd[0]>i||e.selEnd[1]>n.text.length?n.text.length:e.selEnd[1];t.push(n.text.substring(0===o&&this.lineHasMarker(n)?1:o,s))}return t.join("\n")},t.prototype.getLastLine=function(e,t){let n=t.selEnd[0];return n>e&&this.lastLineSelectedIsEmpty(t,n)&&n--,n},t.prototype.lastLineSelectedIsEmpty=function(e,t){const n=e.lines.atIndex(t),i=this.lineHasMarker(n)?1:0;return e.selEnd[1]===i},t.prototype.lineHasMarker=function(e){return 1===e.lineMarker},t.prototype.cleanLine=function(e,t){return this.lineHasMarker(e)&&(t=t.substring(1)),t},t.prototype.saveLink=async function(e,t){const n=await this._send("addLink",e);if(null==n)return;const[i,o]=n;o.linkId=i,this.ace.callWithAce((e=>{t=e.ace_getRep(),e.ace_performSelectionChange(t.selStart,t.selEnd,!0),e.ace_setAttributeOnSelection("link",i)}),"insertLink",!0),this.setLink(i,o)},t.prototype.saveLinkWithoutSelection=async function(e,t){const n=this.buildLinks(t),i=await this._send("bulkAddLink",e,n);this.setLinks(i)},t.prototype.buildLinks=function(e){const t=[];for(const n in e)if(!Object.hasOwn(e,n)){const i=this.buildLink(n,e[n].data);t.push(i)}return t},t.prototype.buildLink=function(e,t){const n={};return n.padId=this.padId,n.linkId=e,n.text=t.text,n.hyperlink=t.hyperlink,n.changeTo=t.changeTo,n.changeFrom=t.changeFrom,n.name=t.name,n.timestamp=parseInt(t.timestamp),n},t.prototype._send=async function(e,...t){return await new Promise(((n,i)=>{this.socket.emit(e,...t,((e,t)=>{if(null!=e)return i(Object.assign(new Error(e.message),{name:e.name}));n(t)}))}))},t.prototype.getMapfakeLinks=function(){return this.mapFakeLinks},t.prototype.findLinkText=function(e){return e.find(".compact-display-content .link-text-text, .full-display-link .link-title-wrapper .link-text-text")},t.prototype.findHyperLinkText=function(e){return e.find(".compact-display-content .link-text-hyperlink, .full-display-link .link-title-wrapper .link-text-hyperlink")},t.prototype.updateLinkBoxText=function(e,t,n){const i=this.container.parent().find(`[data-linkid='${e}']`);i.attr("data-hyperlink",n);this.findLinkText(i).val(t);this.findHyperLinkText(i).val(n)},t.prototype.showChangeAsAccepted=function(e){const t=this,n=this.container.parent().find(`[data-linkid='${e}']`);n.closest(".sidebar-link").find(".link-container.change-accepted").addBack(".change-accepted").each((function(){$(this).removeClass("change-accepted");const e={linkId:$(this).attr("data-linkid"),padId:t.padId};t._send("revertChange",e)})),n.addClass("change-accepted")},t.prototype.showChangeAsReverted=function(e){this.container.parent().find(`[data-linkid='${e}']`).removeClass("change-accepted")},t.prototype.pushLink=function(e,t){const n=this.socket,i=this;n.on("textLinkUpdated",((e,t,n)=>{i.updateLinkBoxText(e,t,n)})),n.on("linkDeleted",(e=>{i.deleteLink(e)})),n.on("changeAccepted",(e=>{i.showChangeAsAccepted(e)})),n.on("changeReverted",(e=>{i.showChangeAsReverted(e)})),"add"===e&&n.on("pushAddLink",((e,n)=>{t(e,n)}))};function n(e,t){const n=this.documentAttributeManager,i=[],o=t.contents().find(e);return $.each(o,((e,t)=>{const o=[[],[]],s=$(t).closest("div"),a=$(s).prevAll("div").length;o[0][0]=a,o[1][0]=a;let r=0,l=!1;const c=n.getAttributesOnLine(a);$.each(c,((e,t)=>{"lmkr"===t[0]&&(l=!0)})),l&&r++,$(t).prevAll("span").each((function(){const e=$(this).text().length;r+=e})),o[0][1]=r,o[1][1]=o[0][1]+$(t).text().length,i.push(o)})),i}const i=(t,n,i)=>e,o=(e,n)=>{pad.plugins||(pad.plugins={});const i=new t(n);return pad.plugins.ep_full_hyperlinks=i,$("#editorcontainerbox").hasClass("flex-layout")||$.gritter.add({title:"Error",text:"ep_full_hyperlinks: Please upgrade to etherpad 1.8.3 for this plugin to work correctly",sticky:!0,class_name:"error"}),[]},s=(e,t,n)=>"link"===t.key&&"link-deleted"!==t.value?["link",t.value]:t.key===preLinkMark.MARK_CLASS&&t.value===clientVars.userId?[preLinkMark.MARK_CLASS,t.value]:[],a=(e,t)=>{pad.plugins||(pad.plugins={});const n=t.callstack.editEvent.eventType;if("setup"!==n&&"setBaseText"!==n&&"importText"!==n)return"unmarkPreSelectedTextToLink"===n?pad.plugins.ep_full_hyperlinks.preLinkMarker.handleUnmarkText(t):"markPreSelectedTextToLink"===n&&pad.plugins.ep_full_hyperlinks.preLinkMarker.handleMarkText(t),[]},r=shared.collectContentPre;exports.aceAttribsToClasses=s,exports.aceEditEvent=a,exports.aceEditorCSS=i,exports.aceInitialized=(e,t)=>{t.editorInfo.ace_getRepFromSelector=n.bind(t)},exports.acePostWriteDomLineHTML=(e,t)=>{const n=$(t.node).find("a");n.length>0&&n.each((function(){$(this).on("click",linkBoxes.internalLinkClick)}))},exports.collectContentPre=r,exports.postAceInit=o;//# sourceMappingURL=bundle.js.map
